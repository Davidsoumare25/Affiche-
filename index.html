<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>PosterMarket</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f4f4;
}

.container {
  max-width: 900px;
  margin: auto;
  padding: 20px;
}

.hidden { display: none; }

input, button {
  display: block;
  margin: 10px 0;
  padding: 10px;
  width: 100%;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
}

.card {
  background: white;
  padding: 10px;
  border-radius: 10px;
}

.card img {
  width: 100%;
  height: 220px;
  object-fit: contain;
  background: #eee;
}
</style>
</head>

<body>
<div class="container">

<!-- AUTH -->
<div id="authView">
  <h2 id="authTitle">Inscription</h2>

  <input id="fullName" placeholder="Nom complet">
  <input id="phone" placeholder="Téléphone WhatsApp">

  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">

  <button onclick="submitAuth()">Valider</button>
  <button onclick="toggleMode()">Déjà un compte ?</button>
</div>

<!-- HOME -->
<div id="homeView" class="hidden">
  <button onclick="showProfile()">Mon profil</button>
  <button onclick="logout()">Logout</button>

  <h2>Catalogue</h2>
  <div id="gallery" class="grid"></div>
</div>

<!-- PROFILE -->
<div id="profileView" class="hidden">
  <button onclick="showHome()">← Retour</button>
  <h2>Ajouter une œuvre</h2>

  <input type="file" id="fileInput">
  <button onclick="uploadImage()">Uploader</button>
</div>

</div>

<script>
const supabase = window.supabase.createClient(
  "https://gjinqdhodzlsjsjnnydl.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqaW5xZGhvZHpsc2pzam5ueWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3ODM2NjgsImV4cCI6MjA4NzM1OTY2OH0.7BH1cGi43_hX6FokAiTmH76tgKtqrgM8urCN_bNJurI"
)

let isSignup = true
let currentUser = null

function show(view) {
  authView.classList.add("hidden")
  homeView.classList.add("hidden")
  profileView.classList.add("hidden")
  view.classList.remove("hidden")
}

function toggleMode() {
  isSignup = !isSignup
  authTitle.innerText = isSignup ? "Inscription" : "Connexion"
  fullName.style.display = isSignup ? "block" : "none"
  phone.style.display = isSignup ? "block" : "none"
}

async function submitAuth() {
  const emailVal = email.value
  const passwordVal = password.value

  if (isSignup) {
    const { data, error } = await supabase.auth.signUp({
      email: emailVal,
      password: passwordVal
    })

    if (error) return alert(error.message)

    await supabase.from("profiles").insert({
      id: data.user.id,
      full_name: fullName.value,
      phone: phone.value
    })

    alert("Compte créé ✔")
  } else {
    const { error } = await supabase.auth.signInWithPassword({
      email: emailVal,
      password: passwordVal
    })
    if (error) alert(error.message)
  }
}

async function logout() {
  await supabase.auth.signOut()
}

function showProfile() { show(profileView) }
function showHome() { loadGallery(); show(homeView) }

async function loadGallery() {
  const { data } = await supabase
    .from("portfolio_items")
    .select("*, profiles(phone)")
    .order("created_at", { ascending: false })

  gallery.innerHTML = ""

  data?.forEach(item => {
    const phone = item.profiles?.phone?.replace(/\D/g, "") || ""
    const card = document.createElement("div")
    card.className = "card"

    card.innerHTML = `
      <img src="${item.image_url}">
      <a href="https://wa.me/${phone}" target="_blank">Contacter</a>
    `
    gallery.appendChild(card)
  })
}

async function uploadImage() {
  const file = fileInput.files[0]
  if (!file) return

  const path = `user-${currentUser.id}/${Date.now()}-${file.name}`

  const { error } = await supabase.storage
    .from("portfolio")
    .upload(path, file)

  if (error) return alert(error.message)

  const { data } = supabase.storage
    .from("portfolio")
    .getPublicUrl(path)

  await supabase.from("portfolio_items").insert({
    user_id: currentUser.id,
    image_url: data.publicUrl
  })

  alert("Image ajoutée ✔")
}

supabase.auth.getSession().then(({ data }) => {
  currentUser = data.session?.user ?? null
  if (currentUser) showHome()
  else show(authView)
})

supabase.auth.onAuthStateChange((event, session) => {
  currentUser = session?.user ?? null
  if (currentUser) showHome()
  else show(authView)
})
</script>
</body>
</html>
