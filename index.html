<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PosterMarket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F0F2F5; }
        .page { display: none; min-height: 100vh; width: 100%; }
        .page.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="page-login" class="page active bg-white flex-col justify-center px-8">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-indigo-600 italic">PosterMarket</h1>
            <p class="text-gray-400 text-sm mt-2 font-bold uppercase tracking-widest">Rejoignez la communauté</p>
        </div>
        <div class="space-y-4 max-w-sm mx-auto w-full">
            <input type="email" id="email" placeholder="Email" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-600">
            <input type="password" id="password" placeholder="Mot de passe" class="w-full p-4 bg-gray-100 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-600">
            <div class="flex gap-2">
                <button onclick="authAction('signup')" class="flex-1 bg-gray-200 py-4 rounded-2xl font-bold">S'inscrire</button>
                <button onclick="authAction('login')" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Entrer</button>
            </div>
            <p id="auth-msg" class="text-[10px] text-center font-bold text-red-500 uppercase mt-4"></p>
        </div>
    </div>

    <div id="page-home" class="page bg-white p-6 space-y-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-black italic">Poster<span class="text-indigo-600">Market</span></h1>
            <button onclick="logout()" class="text-gray-400"><i class="fa-solid fa-power-off"></i></button>
        </div>
        
        <div class="grid gap-4">
            <button onclick="showPage('page-seller-dashboard')" class="bg-indigo-600 p-8 rounded-[2.5rem] text-left text-white shadow-xl shadow-indigo-100 transition active:scale-95">
                <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center mb-4"><i class="fa-solid fa-store text-xl"></i></div>
                <h2 class="text-2xl font-bold">Espace Vendeur</h2>
                <p class="opacity-80 text-xs">Publiez vos affiches et gérez vos ventes</p>
            </button>

            <button onclick="showPage('page-feed')" class="bg-gray-50 p-8 rounded-[2.5rem] text-left border border-gray-100 shadow-lg transition active:scale-95">
                <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center mb-4 text-indigo-600"><i class="fa-solid fa-earth-africa text-xl"></i></div>
                <h2 class="text-2xl font-bold text-gray-900">Explorer le Flux</h2>
                <p class="text-gray-500 text-xs">Découvrez les créations du monde entier</p>
            </button>
        </div>
    </div>

    <div id="page-feed" class="page">
        <nav class="bg-white shadow-sm px-4 py-3 flex justify-between items-center sticky top-0 z-50">
            <button onclick="showPage('page-home')" class="text-gray-600"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="text-indigo-600 font-black text-xl italic">Flux PosterMarket</h2>
            <div class="w-8"></div>
        </nav>
        <div id="global-posts" class="max-w-xl mx-auto pb-20 space-y-2">
            </div>
    </div>

    <div id="page-seller-dashboard" class="page bg-white">
        <nav class="p-4 border-b flex items-center gap-4">
            <button onclick="showPage('page-home')"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="font-bold">Mon Studio de Vente</h2>
        </nav>
        
        <div class="p-6 space-y-6">
            <div class="space-y-4">
                <label class="block">
                    <span class="text-sm font-bold text-gray-700">Photo de l'affiche</span>
                    <div onclick="document.getElementById('post-image').click()" class="mt-2 w-full h-48 bg-gray-50 border-2 border-dashed border-gray-200 rounded-3xl flex flex-col items-center justify-center text-gray-400 overflow-hidden">
                        <img id="preview-img" class="hidden w-full h-full object-cover">
                        <div id="upload-placeholder" class="text-center">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl mb-2"></i>
                            <p class="text-xs">Cliquez pour choisir une image</p>
                        </div>
                    </div>
                    <input type="file" id="post-image" class="hidden" accept="image/*" onchange="previewFile()">
                </label>

                <input type="text" id="post-title" placeholder="Titre de l'affiche..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
                <input type="number" id="post-price" placeholder="Prix (€)..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none">
                
                <button id="btn-publish" onclick="publishPoster()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Publier sur le marché
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gjinqdhodzlsjsjnnydl.supabase.co';
        const SUPABASE_KEY = 'Sb_publishable_4vmTeBhMk99w1vTw6nUlDg_tlUl6zac';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'page-feed') loadGlobalPosts();
        }

        // PREVISUALISATION DE L'IMAGE
        function previewFile() {
            const preview = document.getElementById('preview-img');
            const placeholder = document.getElementById('upload-placeholder');
            const file = document.getElementById('post-image').files[0];
            const reader = new FileReader();

            reader.onloadend = () => {
                preview.src = reader.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
            if (file) reader.readAsDataURL(file);
        }

        // AUTHENTIFICATION
        async function authAction(type) {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { data, error } = (type === 'signup') 
                ? await _supabase.auth.signUp({ email, password })
                : await _supabase.auth.signInWithPassword({ email, password });

            if (error) document.getElementById('auth-msg').innerText = error.message;
            else checkSession();
        }

        async function checkSession() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) showPage('page-home');
            else showPage('page-login');
        }

        // PUBLIER AVEC IMAGE
        async function publishPoster() {
            const btn = document.getElementById('btn-publish');
            btn.disabled = true;
            btn.innerText = "Téléchargement...";

            const { data: { user } } = await _supabase.auth.getUser();
            const file = document.getElementById('post-image').files[0];
            const title = document.getElementById('post-title').value;
            const price = document.getElementById('post-price').value;

            if(!file || !title) return alert("Image et titre obligatoires !");

            // 1. Upload de l'image dans le storage
            const fileName = `${Date.now()}-${file.name}`;
            const { data: uploadData, error: uploadError } = await _supabase.storage
                .from('posters-images')
                .upload(fileName, file);

            if (uploadError) {
                alert("Erreur upload image");
                btn.disabled = false;
                return;
            }

            const imgUrl = _supabase.storage.from('posters-images').getPublicUrl(fileName).data.publicUrl;

            // 2. Création du post dans la table
            const { error: postError } = await _supabase.from('posters').insert([
                { title, price, image_url: imgUrl, seller_id: user.id }
            ]);

            if (postError) alert(postError.message);
            else {
                alert("Publié avec succès !");
                showPage('page-home');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Publier sur le marché';
        }

        // CHARGER LE FLUX
        async function loadGlobalPosts() {
            const feed = document.getElementById('global-posts');
            feed.innerHTML = '<p class="text-center p-10 text-gray-400 text-xs">Mise à jour du flux...</p>';
            
            const { data: posters } = await _supabase
                .from('posters')
                .select('*')
                .order('created_at', { ascending: false });

            if (posters) {
                feed.innerHTML = posters.map(p => `
                    <div class="bg-white border-y md:rounded-3xl md:border md:m-4 overflow-hidden">
                        <div class="p-4 flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-[10px] font-bold">PM</div>
                            <p class="font-bold text-sm">Artiste Professionnel</p>
                        </div>
                        <img src="${p.image_url}" class="w-full aspect-square object-cover bg-gray-100">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="font-bold text-gray-900">${p.title}</h4>
                                <span class="text-indigo-600 font-black">${p.price}€</span>
                            </div>
                            <div class="flex gap-4 mt-4 pt-4 border-t border-gray-50">
                                <button class="flex-1 py-2 bg-gray-50 rounded-xl text-xs font-bold text-gray-600">Détails</button>
                                <button class="flex-1 py-2 bg-indigo-600 rounded-xl text-xs font-bold text-white shadow-md">Acheter</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function logout() { await _supabase.auth.signOut(); showPage('page-login'); }
        window.onload = checkSession;
    </script>
</body>
</html>

