<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>PosterMarket</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --blue1:#0f172a;
  --blue2:#1e3a8a;
  --blue3:#2563eb;
  --bg:#f1f5f9;
}

body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  font-size:18px;
  color:#111;
}

.hidden{display:none}

/* LANDING */
#landing{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--blue1),var(--blue2),var(--blue3));
  color:white;
  text-align:center;
  padding:30px;
}

.landing-box{
  max-width:520px;
}

.landing-box h1{
  font-size:48px;
  margin-bottom:10px;
}

.landing-box p{
  font-size:20px;
  opacity:0.9;
}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:12px;
  margin-top:14px;
  font-size:18px;
  font-weight:600;
  cursor:pointer;
}

.primary{
  background:white;
  color:#1e3a8a;
}

.secondary{
  background:transparent;
  color:white;
  border:2px solid white;
}

/* AUTH */
#authView{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:30px;
}

.card{
  background:white;
  padding:36px;
  border-radius:18px;
  width:100%;
  max-width:480px;
  box-shadow:0 20px 50px rgba(0,0,0,0.1);
}

.card h2{
  font-size:28px;
}

input,select{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:17px;
}

/* HOME */
.container{
  max-width:1200px;
  margin:auto;
  padding:24px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}

.header h2{
  font-size:28px;
  color:#1e3a8a;
}

.menu-btn{
  display:none;
}

.layout{
  display:grid;
  grid-template-columns:260px 1fr;
  gap:24px;
}

.sidebar{
  background:white;
  padding:18px;
  border-radius:14px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:18px;
}

.art{
  background:white;
  padding:12px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,0.05);
}

.art img{
  width:100%;
  height:240px;
  object-fit:contain;
  background:#f1f5f9;
  border-radius:10px;
}

/* MOBILE */
@media(max-width:900px){
  body{font-size:17px}
  .landing-box h1{font-size:36px}
  .layout{grid-template-columns:1fr}
  .menu-btn{display:block}
  .sidebar{display:none}
  .sidebar.open{display:block}
}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="landing-box">
    <h1>PosterMarket</h1>
    <p>Marketplace professionnelle pour affiches design</p>
    <button class="primary" onclick="openAuth(true)">Créer un compte</button>
    <button class="secondary" onclick="openAuth(false)">Se connecter</button>
  </div>
</div>

<!-- AUTH -->
<div id="authView" class="hidden">
  <div class="card">
    <h2 id="authTitle"></h2>

    <select id="role">
      <option value="designer">Designer (je vends mes services)</option>
      <option value="client">Client (je commande une affiche)</option>
    </select>

    <input id="fullName" placeholder="Nom complet">
    <input id="phone" placeholder="Téléphone WhatsApp">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe">

    <button onclick="submitAuth()">Continuer</button>
    <button onclick="backLanding()">Retour</button>

    <p id="status"></p>
  </div>
</div>

<!-- HOME -->
<div id="homeView" class="hidden container">

  <div class="header">
    <h2>PosterMarket</h2>
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
  </div>

  <div class="layout">

    <div id="sidebar" class="sidebar">
      <button onclick="showProfile()">Ajouter une œuvre</button>
      <button onclick="logout()">Déconnexion</button>
    </div>

    <div>
      <div id="gallery" class="grid"></div>
    </div>

  </div>
</div>

<!-- PROFILE -->
<div id="profileView" class="hidden container">
  <div class="card">
    <h3>Nouvelle œuvre</h3>
    <input type="file" id="fileInput">
    <button onclick="uploadImage()">Uploader</button>
    <button onclick="showHome()">Retour</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://lqevweyhxkvnckhtfpwh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxZXZ3ZXloeGt2bmNraHRmcHdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTk2NTIsImV4cCI6MjA4NTYzNTY1Mn0.F6EUcdco3mn8AxlR9CMzxCmcxL-5-BypAhSak0JQSWw"
)

let currentUser=null
let isSignup=true

function show(v){
  landing.classList.add("hidden")
  authView.classList.add("hidden")
  homeView.classList.add("hidden")
  profileView.classList.add("hidden")
  v.classList.remove("hidden")
}

function openAuth(signup){
  isSignup=signup
  authTitle.innerText=signup?"Créer un compte":"Connexion"
  show(authView)
}

function backLanding(){show(landing)}

function toggleMenu(){sidebar.classList.toggle("open")}

function setStatus(m){status.innerText=m}

async function submitAuth(){
  const emailVal=email.value.trim()
  const passwordVal=password.value.trim()

  if(isSignup){
    const {data,error}=await supabase.auth.signUp({
      email:emailVal,
      password:passwordVal
    })

    if(error) return setStatus(error.message)

    if(data.user){
      await supabase.from("profiles").insert({
        id:data.user.id,
        full_name:fullName.value,
        phone:phone.value,
        role:role.value
      })
    }

    setStatus("Compte créé ✔ Connecte-toi")
  }else{
    const {error}=await supabase.auth.signInWithPassword({
      email:emailVal,
      password:passwordVal
    })
    if(error) setStatus(error.message)
  }
}

async function logout(){
  await supabase.auth.signOut()
}

function showProfile(){show(profileView)}

async function showHome(){
  await loadGallery()
  show(homeView)
}

async function loadGallery(){
  const {data}=await supabase
    .from("portfolio_items")
    .select("*, profiles(phone)")

  gallery.innerHTML=""

  data?.forEach(item=>{
    const phone=item.profiles?.phone?.replace(/\D/g,"")||""
    gallery.innerHTML+=`
      <div class="art">
        <img src="${item.image_url}">
        <a href="https://wa.me/${phone}" target="_blank">
          <button>Contacter</button>
        </a>
      </div>
    `
  })
}

async function uploadImage(){
  const file=fileInput.files[0]
  if(!file) return

  const path=`user-${currentUser.id}/${Date.now()}-${file.name}`

  await supabase.storage.from("portfolio").upload(path,file)

  const {data}=supabase.storage.from("portfolio").getPublicUrl(path)

  await supabase.from("portfolio_items").insert({
    user_id:currentUser.id,
    image_url:data.publicUrl
  })

  showHome()
}

supabase.auth.getSession().then(({data})=>{
  currentUser=data.session?.user??null
  if(currentUser) showHome()
})

supabase.auth.onAuthStateChange((e,s)=>{
  currentUser=s?.user??null
  if(currentUser) showHome()
})
</script>

</body>
</html>
