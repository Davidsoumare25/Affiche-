<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PosterMarket Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F3F4F6; }
        .page { display: none; min-height: 100vh; width: 100%; }
        .page.active { display: block; }
        .input-field { width: 100%; padding: 16px; background: #F9FAFB; border-radius: 16px; border: 1px solid #E5E7EB; outline: none; }
        .input-field:focus { border-color: #4F46E5; ring: 2px; ring-color: #4F46E5; }
        .btn-primary { background: #4F46E5; color: white; padding: 16px; border-radius: 16px; font-weight: bold; width: 100%; transition: all 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .portfolio-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .portfolio-item { aspect-ratio: 1; border-radius: 12px; object-fit: cover; background: #E5E7EB; width: 100%; }
    </style>
</head>
<body>

    <div id="page-auth" class="page active bg-white px-8 py-12">
        <div class="max-w-sm mx-auto">
            <h1 class="text-3xl font-black text-indigo-600 italic mb-2">PosterMarket</h1>
            <p class="text-gray-400 mb-8 font-medium">Créez votre profil de designer</p>
            
            <div id="auth-form" class="space-y-4">
                <input type="text" id="reg-name" placeholder="Nom complet" class="input-field">
                <input type="tel" id="reg-phone" placeholder="Numéro de téléphone" class="input-field">
                <input type="email" id="reg-email" placeholder="Email" class="input-field">
                <input type="password" id="reg-pass" placeholder="Mot de passe" class="input-field">
                
                <button onclick="handleAuth('signup')" class="btn-primary mt-4 shadow-lg shadow-indigo-100">Créer mon compte</button>
                <button onclick="toggleAuthMode()" class="w-full text-sm text-gray-500 font-bold py-2">Déjà inscrit ? Se connecter</button>
            </div>
            <p id="auth-msg" class="text-xs text-red-500 mt-4 text-center font-bold uppercase"></p>
        </div>
    </div>

    <div id="page-home" class="page">
        <nav class="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-50">
            <span class="font-black italic text-indigo-600 text-xl">PM</span>
            <div class="flex gap-4">
                <button onclick="showPage('page-profile')" class="text-gray-600"><i class="fa-solid fa-circle-user text-xl"></i></button>
                <button onclick="logout()" class="text-red-400"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </nav>
        <div class="p-6">
            <h2 class="text-2xl font-extrabold mb-6">Explorer les <span class="text-indigo-600">Talents</span></h2>
            <div id="designer-feed" class="space-y-6">
                </div>
        </div>
    </div>

    <div id="page-profile" class="page bg-white">
        <div class="h-40 bg-gray-100 relative" id="prof-cover" style="background-size: cover; background-position: center;">
            <button onclick="triggerFile('cover')" class="absolute bottom-2 right-2 bg-black/50 text-white p-2 rounded-full text-xs"><i class="fa-solid fa-camera"></i></button>
        </div>
        <div class="px-6 -mt-10 relative">
            <div id="prof-avatar" class="h-20 w-20 rounded-2xl bg-indigo-500 border-4 border-white shadow-md bg-cover bg-center"></div>
            <button onclick="triggerFile('avatar')" class="absolute top-14 left-16 bg-indigo-600 text-white h-7 w-7 rounded-full border-2 border-white flex items-center justify-center"><i class="fa-solid fa-plus text-[10px]"></i></button>
            
            <div class="mt-4">
                <h3 id="prof-name" class="text-xl font-black">Chargement...</h3>
                <p id="prof-phone" class="text-sm text-gray-400 font-bold"></p>
                <textarea id="prof-bio" onblur="saveBio()" class="w-full mt-2 text-sm text-gray-500 outline-none" placeholder="Ajouter une description..."></textarea>
            </div>
        </div>

        <div class="p-6 border-t mt-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-xs uppercase tracking-widest text-gray-400">Mon Portfolio</h4>
                <button onclick="triggerFile('portfolio')" class="text-indigo-600 font-bold text-xs bg-indigo-50 px-3 py-1 rounded-full">+ Ajouter</button>
            </div>
            <div id="prof-portfolio" class="portfolio-grid">
                </div>
        </div>
        <button onclick="showPage('page-home')" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-black text-white px-8 py-3 rounded-full font-bold shadow-2xl text-sm">Retour à l'accueil</button>
    </div>

    <input type="file" id="file-helper" class="hidden" onchange="uploadProcess(this)">

    <script>
        const SB_URL = 'https://gjinqdhodzlsjsjnnydl.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqaW5xZGhvZHpsc2pzam5ueWRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3ODM2NjgsImV4cCI6MjA4NzM1OTY2OH0.7BH1cGi43_hX6FokAiTmH76tgKtqrgM8urCN_bNJurI';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let currentType = '';

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'page-home') loadAllDesigners();
            if(id === 'page-profile') loadMyProfile();
        }

        async function handleAuth(mode) {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;

            if(mode === 'signup') {
                const { data, error } = await _sb.auth.signUp({ email, password: pass });
                if(error) return alert(error.message);
                // Sauvegarde du nom et tel dans la table profiles
                await _sb.from('profiles').upsert({ id: data.user.id, full_name: name, phone: phone });
            } else {
                const { error } = await _sb.auth.signInWithPassword({ email, password: pass });
                if(error) return alert(error.message);
            }
            checkSession();
        }

        async function checkSession() {
            const { data: { session } } = await _sb.auth.getSession();
            if(session) showPage('page-home');
        }

        function triggerFile(type) { currentType = type; document.getElementById('file-helper').click(); }

        async function uploadProcess(input) {
            const file = input.files[0];
            if(!file) return;
            const { data: { user } } = await _sb.auth.getUser();
            const path = `${user.id}/${Date.now()}_${file.name}`;
            const bucket = (currentType === 'portfolio') ? 'portfolio' : (currentType === 'avatar' ? 'avatars' : 'covers');

            const { data, error } = await _sb.storage.from(bucket).upload(path, file);
            if(error) return alert("Erreur : Vérifiez que vos buckets Storage sont en PUBLIC !");

            const url = _sb.storage.from(bucket).getPublicUrl(path).data.publicUrl;

            if(currentType === 'portfolio') {
                await _sb.from('portfolio').insert({ designer_id: user.id, image_url: url });
            } else {
                const up = currentType === 'avatar' ? { avatar_url: url } : { cover_url: url };
                await _sb.from('profiles').update(up).eq('id', user.id);
            }
            loadMyProfile();
        }

        async function loadMyProfile() {
            const { data: { user } } = await _sb.auth.getUser();
            const { data: prof } = await _sb.from('profiles').select('*').eq('id', user.id).single();
            if(prof) {
                document.getElementById('prof-name').innerText = prof.full_name || 'Nom non défini';
                document.getElementById('prof-phone').innerText = prof.phone || '';
                document.getElementById('prof-bio').value = prof.bio || '';
                if(prof.avatar_url) document.getElementById('prof-avatar').style.backgroundImage = `url(${prof.avatar_url})`;
                if(prof.cover_url) document.getElementById('prof-cover').style.backgroundImage = `url(${prof.cover_url})`;
            }
            const { data: port } = await _sb.from('portfolio').select('*').eq('designer_id', user.id);
            document.getElementById('prof-portfolio').innerHTML = port?.map(i => `<img src="${i.image_url}" class="portfolio-item">`).join('') || '';
        }

        async function loadAllDesigners() {
            const feed = document.getElementById('designer-feed');
            const { data: designers } = await _sb.from('profiles').select('*, portfolio(*)');
            feed.innerHTML = designers?.map(d => `
                <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-gray-100">
                    <div class="flex gap-4 items-center">
                        <img src="${d.avatar_url || ''}" class="h-14 w-14 rounded-2xl bg-indigo-100 object-cover">
                        <div>
                            <h4 class="font-bold text-gray-900">${d.full_name || 'Designer'}</h4>
                            <p class="text-xs text-indigo-600 font-bold">${d.phone || ''}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-4">
                        ${d.portfolio?.slice(0,3).map(p => `<img src="${p.image_url}" class="h-20 w-full object-cover rounded-xl">`).join('')}
                    </div>
                    <button class="w-full mt-4 py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xs uppercase">Voir le catalogue complet</button>
                </div>
            `).join('') || 'Aucun designer';
        }

        function logout() { _sb.auth.signOut(); showPage('page-auth'); }
        window.onload = checkSession;
    </script>
</body>
</html>

